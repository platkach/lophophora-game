<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Guess the Lophophora Species</title>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

html, body {
  margin: 0;
  height: 100%;
  background: #f3f7f3;
  overflow: hidden; /* Prevent body scroll */
}

h1 {
  margin: 0;
  padding: 10px 0 5px 0;
  text-align: center;
  font-size: 1.5rem;
  height: 40px;
}

#scoreboard {
  text-align: center;
  font-size: 14px;
  margin-bottom: 5px;
  height: 20px;
}

#layout {
  display: flex;
  /* Use dvh for mobile address bar compatibility, fallback to vh */
  height: calc(100vh - 70px); 
  height: calc(100dvh - 70px);
  width: 100%;
}

/* ======================
   HISTORY (Sidebar on Desktop)
====================== */

#history-panel {
  width: 220px; /* Slightly wider for readability */
  padding: 8px;
  border-right: 2px solid #ddd;
  overflow-y: auto;
  font-size: 12px;
  background: #fff;
  flex-shrink: 0;
}

.history-item {
  margin-bottom: 10px;
  border-bottom: 1px solid #eee;
  padding-bottom: 5px;
}

.history-item img {
  width: 100%;
  border-radius: 6px;
  display: block;
}

/* ======================
   GAME PANEL
====================== */

#game-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  overflow: hidden;
}

#game-panel h2 {
    margin: 5px 0;
    font-size: 1rem;
    color: #555;
}

/* Image Area - Flex 1 lets it grow/shrink to fill space */
#current {
  flex: 1; 
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  padding: 10px;
  min-height: 0; /* Crucial for flex nested scrolling */
}

#current img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Buttons Area - Fixed size content */
#buttons {
  width: 100%;
  max-width: 500px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex-shrink: 0; /* Prevent buttons from being squashed */
  background: #f3f7f3; /* Ensure background covers content behind */
}

button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: white;
  transition: transform 0.1s;
  touch-action: manipulation; /* Improves touch response */
}

button:active {
  transform: scale(0.98);
}

.correct {
  background: #4caf50 !important;
  color: white;
  border-color: #388e3c;
}

.wrong {
  background: #e53935 !important;
  color: white;
  border-color: #d32f2f;
}

/* ======================
   MOBILE LAYOUT
====================== */

@media (max-width: 800px) {
  
  h1 {
    font-size: 1.2rem;
  }

  #layout {
    flex-direction: column;
    /* Recalculate height to fill screen exactly */
    height: calc(100dvh - 65px); 
  }

  /* 1. MOVE GAME TO TOP */
  #game-panel {
    order: 1;
    width: 100%;
    flex: 1; /* Take up all available vertical space */
  }

  /* 2. MOVE HISTORY TO BOTTOM */
  #history-panel {
    order: 2;
    width: 100%; /* Fix: Was stuck at 180px */
    height: 120px; /* Fixed height strip at bottom */
    border-right: none;
    border-top: 2px solid #ddd;
    display: flex; /* Horizontal scroll layout for history */
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 10px;
    background: #f9f9f9;
  }

  /* Adjust history items for horizontal strip */
  .history-item {
    min-width: 80px;
    width: 80px;
    font-size: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border-bottom: none;
    margin-bottom: 0;
  }
  
  .history-item img {
    height: 60px;
    object-fit: cover;
  }

  /* Adjust buttons for touch */
  #buttons {
    padding: 5px 15px 10px 15px;
  }
  
  button {
    padding: 14px; /* Larger touch target */
    margin: 0; /* Gap handled by parent flex gap */
  }
}
</style>
</head>

<body>

<h1>Guess the Species</h1>

<div id="scoreboard">
  Score: <b id="score">0</b> |
  Streak: <b id="streak">1</b>
</div>

<div id="layout">

  <div id="history-panel">
    </div>

  <div id="game-panel">
    <div id="current">Loadingâ€¦</div>
    <div id="buttons"></div>
  </div>
</div>

<script>
/* ======================
   TAXA
====================== */

const speciesPool = [
  { name: "Lophophora williamsii", taxon: 164777 },
  { name: "Lophophora fricii", taxon: 439808 },
  { name: "Lophophora diffusa", taxon: 204983 },
  { name: "Lophophora koehresii", taxon: 637224 },
  { name: "Lophophora alberto-vojtechii", taxon: 502521 }
];

let queue = [];
let seen = new Set();
let correctSpecies = "";
let observationURL = "";
let currentHTML = "";
let locked = false;

let score = 0;
let streak = 1;

/* normalize subspecies */
function normalize(name) {
  return name
    .toLowerCase()
    .replace("lophophora", "")
    .trim()
    .split(" ")[0];
}

/* ======================
   FETCH
====================== */

async function refillQueue() {
  queue = [];

  for (const s of speciesPool) {
    const url =
      `https://api.inaturalist.org/v1/observations` +
      `?taxon_id=${s.taxon}` +
      `&quality_grade=research` +
      `&photos=true` +
      `&identifications_count=3` + // Reduced slightly for better yield
      `&per_page=50`;

    try {
        const r = await fetch(url);
        const d = await r.json();

        d.results.forEach(o => {
          if (o.photos?.length) queue.push(o);
        });
    } catch (e) {
        console.error("Fetch failed", e);
    }
  }

  shuffle(queue);
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

/* ======================
   LOAD
====================== */

async function loadRandom() {
  locked = false;

  if (queue.length === 0) {
    seen.clear();
    document.getElementById("current").innerText = "Refilling queue...";
    await refillQueue();
  }

  let obs;

  // Simple safety break to prevent infinite loops if all seen
  let attempts = 0;
  do {
    obs = queue.shift();
    attempts++;
  } while (seen.has(obs.id) && queue.length && attempts < 500);

  if(!obs) {
     // Failsafe if queue empty
     await refillQueue();
     obs = queue.shift();
  }

  seen.add(obs.id);

  const photo = obs.photos[0].url.replace("square", "large");

  document.getElementById("current").innerHTML =
    `<img src="${photo}">`;

  correctSpecies = obs.taxon.name;
  observationURL = obs.uri;
  currentHTML = `<img src="${photo}">`;

  const buttons = document.getElementById("buttons");
  buttons.innerHTML = "";

  speciesPool.forEach(s => {
    const b = document.createElement("button");
    b.textContent = s.name;
    b.onclick = () => checkAnswer(b, s.name);
    buttons.appendChild(b);
  });
}

/* ======================
   ANSWER
====================== */

function checkAnswer(btn, guess) {
  if (locked) return;
  locked = true;

  const correct =
    normalize(guess) === normalize(correctSpecies);

  document.querySelectorAll("#buttons button")
    .forEach(b => b.disabled = true);

  if (correct) {
    btn.classList.add("correct");
    score += streak;
    streak++;
  } else {
    btn.classList.add("wrong");
    streak = 1;

    document.querySelectorAll("#buttons button")
      .forEach(b => {
        if (normalize(b.textContent) === normalize(correctSpecies))
          b.classList.add("correct");
      });
  }

  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;

  history.unshift({
    html: currentHTML,
    species: correctSpecies,
    url: observationURL
  });

  if (history.length > 10) history.pop();
  renderHistory();

  setTimeout(loadRandom, 1400);
}

/* ======================
   HISTORY
====================== */

let historyList = []; // Renamed variable to avoid conflict with window.history

function renderHistory() {
  const h = document.getElementById("history-panel");
  // Keep the heading on desktop, clear content 
  // Simplified for this demo: just rebuild list
  h.innerHTML = "";
  
  // On Desktop we might want a header, on mobile maybe not. 
  // Let's just render items.
  
  historyList.forEach(i => {
    const d = document.createElement("div");
    d.className = "history-item";
    d.innerHTML = `
      ${i.html}
      <div style="margin-top:2px;"><b>${i.species.split(' ')[1]}</b></div>
      <a href="${i.url}" target="_blank" style="text-decoration:none; color:#2196F3;">View</a>
    `;
    h.appendChild(d);
  });
}

/* ======================
   START
====================== */

// Fix history variable scope issue
historyList = []; 

// Override original history logic slightly to use historyList
window.checkAnswer = function(btn, guess) {
  if (locked) return;
  locked = true;

  const correct = normalize(guess) === normalize(correctSpecies);

  document.querySelectorAll("#buttons button").forEach(b => b.disabled = true);

  if (correct) {
    btn.classList.add("correct");
    score += streak;
    streak++;
  } else {
    btn.classList.add("wrong");
    streak = 1;
    document.querySelectorAll("#buttons button").forEach(b => {
      if (normalize(b.textContent) === normalize(correctSpecies))
        b.classList.add("correct");
    });
  }

  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;

  historyList.unshift({
    html: currentHTML,
    species: correctSpecies,
    url: observationURL
  });

  if (historyList.length > 10) historyList.pop();
  renderHistory();

  setTimeout(loadRandom, 1400);
};

(async () => {
  document.getElementById("current").innerText = "Loading...";
  await refillQueue();
  loadRandom();
})();
</script>

</body>
</html>
