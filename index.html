<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Guess the Lophophora Species</title>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

html, body {
  margin: 0;
  height: 100%;
  background: #f3f7f3;
}

/* ======================
   DESKTOP LAYOUT
====================== */

body {
  overflow: hidden;
}

h1 {
  margin: 6px 0;
  text-align: center;
}

#scoreboard {
  text-align: center;
  font-size: 14px;
  margin-bottom: 6px;
}

#layout {
  display: flex;
  height: calc(100vh - 90px);
}

/* ======================
   HISTORY
====================== */

#history-panel {
  width: 180px;
  padding: 8px;
  border-right: 2px solid #ddd;
  overflow-y: auto;
  font-size: 12px;
}

.history-item img {
  width: 100%;
  border-radius: 6px;
}

/* ======================
   GAME PANEL
====================== */

#game-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* image area = FIXED SPACE */
#current {
  height: 65%;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

#current img {
  max-width: 95%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 10px;
}

/* buttons always visible */
#buttons {
  height: 35%;
  width: 90%;
  padding-bottom: 10px;
  overflow: hidden;
}

button {
  width: 100%;
  padding: 9px;
  margin: 5px 0;
  font-size: 15px;
  cursor: pointer;
}

.correct {
  background: #4caf50;
  color: white;
}

.wrong {
  background: #e53935;
  color: white;
}

/* ======================
   MOBILE
====================== */

@media (max-width: 800px) {

  body {
    overflow-y: auto;
  }

  #layout {
    flex-direction: column;
    height: auto;
  }

  #history-panel {
    width: 100%;
    border-right: none;
    border-top: 2px solid #ddd;
    max-height: 40vh;
  }

  #current {
    height: auto;
  }

  #current img {
    max-height: 60vh;
  }

  #buttons {
    height: auto;
  }
}
</style>
</head>

<body>

<h1>Guess the Lophophora Species</h1>

<div id="scoreboard">
  Score: <b id="score">0</b> |
  Streak: <b id="streak">1</b>
</div>

<div id="layout">

  <div id="history-panel">
    <b>History</b>
    <div id="history"></div>
  </div>

  <div id="game-panel">

    <h2>Current</h2>

    <div id="current">Loadingâ€¦</div>

    <div id="buttons"></div>

  </div>
</div>

<script>
/* ======================
   TAXA
====================== */

const speciesPool = [
  { name: "Lophophora williamsii", taxon: 164777 },
  { name: "Lophophora fricii", taxon: 439808 },
  { name: "Lophophora diffusa", taxon: 204983 },
  { name: "Lophophora koehresii", taxon: 637224 },
  { name: "Lophophora alberto-vojtechii", taxon: 502521 }
];

let queue = [];
let seen = new Set();
let correctSpecies = "";
let observationURL = "";
let currentHTML = "";
let locked = false;

let score = 0;
let streak = 1;

/* normalize subspecies */
function normalize(name) {
  return name
    .toLowerCase()
    .replace("lophophora", "")
    .trim()
    .split(" ")[0];
}

/* ======================
   FETCH
====================== */

async function refillQueue() {
  queue = [];

  for (const s of speciesPool) {
    const url =
      `https://api.inaturalist.org/v1/observations` +
      `?taxon_id=${s.taxon}` +
      `&quality_grade=research` +
      `&photos=true` +
      `&identifications_count=5` +
      `&per_page=200`;

    const r = await fetch(url);
    const d = await r.json();

    d.results.forEach(o => {
      if (o.photos?.length) queue.push(o);
    });
  }

  shuffle(queue);
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

/* ======================
   LOAD
====================== */

async function loadRandom() {
  locked = false;

  if (queue.length === 0) {
    seen.clear();
    await refillQueue();
  }

  let obs;

  do {
    obs = queue.shift();
  } while (seen.has(obs.id) && queue.length);

  seen.add(obs.id);

  const photo = obs.photos[0].url.replace("square", "large");

  document.getElementById("current").innerHTML =
    `<img src="${photo}">`;

  correctSpecies = obs.taxon.name;
  observationURL = obs.uri;
  currentHTML = `<img src="${photo}">`;

  const buttons = document.getElementById("buttons");
  buttons.innerHTML = "";

  speciesPool.forEach(s => {
    const b = document.createElement("button");
    b.textContent = s.name;
    b.onclick = () => checkAnswer(b, s.name);
    buttons.appendChild(b);
  });
}

/* ======================
   ANSWER
====================== */

function checkAnswer(btn, guess) {
  if (locked) return;
  locked = true;

  const correct =
    normalize(guess) === normalize(correctSpecies);

  document.querySelectorAll("#buttons button")
    .forEach(b => b.disabled = true);

  if (correct) {
    btn.classList.add("correct");
    score += streak;
    streak++;
  } else {
    btn.classList.add("wrong");
    streak = 1;

    document.querySelectorAll("#buttons button")
      .forEach(b => {
        if (normalize(b.textContent) === normalize(correctSpecies))
          b.classList.add("correct");
      });
  }

  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;

  history.unshift({
    html: currentHTML,
    species: correctSpecies,
    url: observationURL
  });

  if (history.length > 10) history.pop();
  renderHistory();

  setTimeout(loadRandom, 1400);
}

/* ======================
   HISTORY
====================== */

let history = [];

function renderHistory() {
  const h = document.getElementById("history");
  h.innerHTML = "";

  history.forEach(i => {
    const d = document.createElement("div");
    d.className = "history-item";
    d.innerHTML = `
      ${i.html}
      <div><i>${i.species}</i></div>
      <a href="${i.url}" target="_blank">View</a>
    `;
    h.appendChild(d);
  });
}

/* ======================
   START
====================== */

(async () => {
  await refillQueue();
  loadRandom();
})();
</script>

</body>
</html>
