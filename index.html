<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Guess the Lophophora Species</title>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }

html, body {
  margin: 0;
  height: 100%;
  background: #f3f7f3;
  overflow: hidden;
}

h1 { margin: 0; padding: 10px 0 5px 0; text-align: center; font-size: 1.5rem; height: 40px; }

#scoreboard {
  text-align: center;
  font-size: 14px;
  margin-bottom: 5px;
  height: 25px;
}

#reset-btn {
    font-size: 10px;
    padding: 2px 5px;
    margin-left: 10px;
    cursor: pointer;
    vertical-align: middle;
}

#layout {
  display: flex;
  height: calc(100dvh - 75px);
  width: 100%;
}

/* HISTORY */
#history-panel {
  width: 220px;
  padding: 8px;
  border-right: 2px solid #ddd;
  overflow-y: auto;
  font-size: 12px;
  background: #fff;
  flex-shrink: 0;
}

.history-item-link {
  text-decoration: none;
  color: inherit;
  display: block;
  margin-bottom: 12px;
}

.history-item { 
  border-radius: 8px;
  padding: 4px;
  background: #fff;
  transition: opacity 0.2s;
}

.history-item:hover { opacity: 0.8; }
.hist-correct { border: 3px solid #4caf50; }
.hist-wrong { border: 3px solid #e53935; }

.history-item img { width: 100%; height: 140px; object-fit: cover; border-radius: 4px; display: block; }

/* GAME */
#game-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  overflow: hidden;
}

/* Updated current container to allow panning/scrolling */
#current {
  flex: 1; 
  width: 100%;
  overflow: auto; /* Allows the finger-drag/scroll */
  display: block; /* Changed from flex to allow natural image overflow */
  padding: 10px;
  min-height: 0;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  cursor: grab;
}

#current:active { cursor: grabbing; }

#current img {
  display: block;
  margin: 0 auto;
  min-width: 100%;
  min-height: 100%;
  /* Contain ensures we don't lose the plant, 
     but min-width/height keeps it fill-ready */
  object-fit: contain; 
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#buttons {
  width: 100%;
  max-width: 500px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex-shrink: 0;
  background: #f3f7f3;
  z-index: 10;
}

button.answer-btn {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: white;
  transition: transform 0.1s;
  touch-action: manipulation;
}

button:active { transform: scale(0.98); }
.correct { background: #4caf50 !important; color: white; border-color: #388e3c; }
.wrong { background: #e53935 !important; color: white; border-color: #d32f2f; }

@media (max-width: 800px) {
  #layout { flex-direction: column; height: calc(100dvh - 75px); }
  #game-panel { order: 1; width: 100%; flex: 1; }
  #history-panel {
    order: 2; width: 100%; height: 130px; border-right: none;
    border-top: 2px solid #ddd; display: flex; flex-direction: row;
    overflow-x: auto; overflow-y: hidden; gap: 10px; background: #f9f9f9;
  }
  .history-item-link { min-width: 100px; width: 100px; margin-bottom: 0; }
  .history-item img { height: 70px; }
  .history-item div { font-size: 9px; line-height: 1.1; margin-top: 4px; }
  #buttons { padding: 5px 10px 8px 10px; gap: 5px; }
  button.answer-btn { padding: 10px; font-size: 14px; border-radius: 6px; }
}
</style>
</head>

<body>

<h1>Guess the Species</h1>

<div id="scoreboard">
  Score: <b id="score">0</b> | Streak: <b id="streak">1</b>
  <button id="reset-btn" onclick="clearMemory()">Reset Seen Data</button>
</div>

<div id="layout">
  <div id="history-panel"></div>
  <div id="game-panel">
    <div id="current">Loadingâ€¦</div>
    <div id="buttons"></div>
  </div>
</div>

<script>
const speciesPool = [
  { name: "Lophophora williamsii", taxon: 164777 },
  { name: "Lophophora fricii", taxon: 439808 },
  { name: "Lophophora diffusa", taxon: 204983 },
  { name: "Lophophora koehresii", taxon: 637224 },
  { name: "Lophophora alberto-vojtechii", taxon: 502521 }
];

let queue = [];
let seen = new Set();
let correctSpecies = "";
let observationURL = "";
let currentHTML = "";
let locked = false;
let historyList = [];
let score = 0;
let streak = 1;

function loadSeenFromStorage() {
    const data = localStorage.getItem('lophophora_seen_ids');
    if (data) seen = new Set(JSON.parse(data));
}

function saveSeenToStorage() {
    localStorage.setItem('lophophora_seen_ids', JSON.stringify(Array.from(seen)));
}

function clearMemory() {
    if(confirm("Clear all 'seen' history?")) {
        localStorage.removeItem('lophophora_seen_ids');
        location.reload();
    }
}

function normalize(name) {
  return name.toLowerCase().replace("lophophora", "").trim().split(" ")[0];
}

async function refillQueue() {
  queue = [];
  for (const s of speciesPool) {
    const url = `https://api.inaturalist.org/v1/observations?taxon_id=${s.taxon}&quality_grade=research&photos=true&identifications_count=3&per_page=100`;
    try {
        const r = await fetch(url);
        const d = await r.json();
        d.results.forEach(o => { 
            if (o.photos?.length && !seen.has(o.id)) queue.push(o); 
        });
    } catch (e) { console.error(e); }
  }
  shuffle(queue);
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

async function loadRandom() {
  locked = false;
  const currentDiv = document.getElementById("current");
  
  if (queue.length === 0) {
    currentDiv.innerText = "Finding new plants...";
    await refillQueue();
    if (queue.length === 0) { seen.clear(); await refillQueue(); }
  }

  let obs = queue.shift();
  seen.add(obs.id);
  saveSeenToStorage();

  const photo = obs.photos[0].url.replace("square", "large");
  
  // Set image and reset scroll position to center
  currentDiv.innerHTML = `<img src="${photo}" id="active-img">`;
  const img = document.getElementById("active-img");
  
  img.onload = () => {
    currentDiv.scrollLeft = (img.scrollWidth - currentDiv.clientWidth) / 2;
    currentDiv.scrollTop = (img.scrollHeight - currentDiv.clientHeight) / 2;
  };

  correctSpecies = obs.taxon.name;
  observationURL = obs.uri;
  currentHTML = `<img src="${photo}">`;

  const buttons = document.getElementById("buttons");
  buttons.innerHTML = "";
  speciesPool.forEach(s => {
    const b = document.createElement("button");
    b.className = "answer-btn";
    b.textContent = s.name;
    b.onclick = () => checkAnswer(b, s.name);
    buttons.appendChild(b);
  });
}

function checkAnswer(btn, guess) {
  if (locked) return;
  locked = true;
  const isCorrect = normalize(guess) === normalize(correctSpecies);
  document.querySelectorAll("#buttons button").forEach(b => b.disabled = true);

  if (isCorrect) {
    btn.classList.add("correct");
    score += streak;
    streak++;
  } else {
    btn.classList.add("wrong");
    streak = 1;
    document.querySelectorAll("#buttons button").forEach(b => {
      if (normalize(b.textContent) === normalize(correctSpecies)) b.classList.add("correct");
    });
  }

  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;
  
  historyList.unshift({ 
    html: currentHTML, 
    species: correctSpecies, 
    url: observationURL,
    wasCorrect: isCorrect
  });
  
  if (historyList.length > 15) historyList.pop();
  renderHistory();
  setTimeout(loadRandom, 1400);
}

function renderHistory() {
  const h = document.getElementById("history-panel");
  h.innerHTML = "";
  historyList.forEach(i => {
    const link = document.createElement("a");
    link.href = i.url;
    link.target = "_blank";
    link.className = "history-item-link";
    
    const d = document.createElement("div");
    d.className = `history-item ${i.wasCorrect ? 'hist-correct' : 'hist-wrong'}`;
    d.innerHTML = `
        ${i.html}
        <div style="margin-top:4px; font-weight:bold;">${i.species}</div>
    `;
    link.appendChild(d);
    h.appendChild(link);
  });
}

(async () => {
  loadSeenFromStorage();
  document.getElementById("current").innerText = "Loading...";
  await refillQueue();
  loadRandom();
})();
</script>
</body>
</html>
